# azure-pipelines.yml
trigger:
  branches:
    include:
      - main

variables:
  rm: rm554983
  location: eastus
  resourceGroup: rg-sprint-Nextpark
  appPlan: planNextpark
  appName: nextpark-sprint-$(rm)
  acrName: nextparkacr$(rm)
  imageName: nextpark
  sku: B1

# Use Microsoft-hosted agent com tudo pronto
pool:
  name: 'Default'

stages:
# ================== 1) INFRA ==================
- stage: criarInfra
  displayName: 'Criar infraestrutura (RG, Plan, ACR, WebApp)'
  jobs:
  - job: infra
    displayName: 'Provisionar Azure (idempotente)'
    steps:
    - task: AzureCLI@2
      displayName: 'Criar RG, Plan, ACR (admin) e WebApp (container)'
      inputs:
        azureSubscription: 'MyAzureSubscription'
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          set -e

          rg='$(resourceGroup)'
          loc='$(location)'
          plan='$(appPlan)'
          app='$(appName)'
          acr='$(acrName)'
          sku='$(sku)'

          # RG
          az group create -n "$rg" -l "$loc" 1>/dev/null

          # App Service Plan (Linux)
          if ! az appservice plan show -n "$plan" -g "$rg" >/dev/null 2>&1; then
            az appservice plan create -n "$plan" -g "$rg" --sku "$sku" --is-linux 1>/dev/null
          fi

          # ACR (admin on para simplificar o deploy)
          if ! az acr show -n "$acr" -g "$rg" >/dev/null 2>&1; then
            az acr create -n "$acr" -g "$rg" -l "$loc" --sku Basic --admin-enabled true 1>/dev/null
          fi

          # WebApp for Containers (imagem placeholder)
          if ! az webapp show -g "$rg" -n "$app" >/dev/null 2>&1; then
            az webapp create -g "$rg" -p "$plan" -n "$app" --deployment-container-image-name "hello-world" 1>/dev/null
          fi

          echo "Infra OK: RG=$rg PLAN=$plan ACR=$acr APP=$app"

    - task: AzureCLI@2
      displayName: 'Configurar App Settings (DB_URL/DB_USER/DB_PASS)'
      inputs:
        azureSubscription: 'MyAzureSubscription'
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          az webapp config appsettings set \
            -g '$(resourceGroup)' -n '$(appName)' --settings \
            DB_URL='$(DB_URL)' \
            DB_USER='$(DB_USER)' \
            DB_PASS='$(DB_PASS)' 1>/dev/null
          echo "App settings definidos."

# ================== 2) CI ==================
- stage: BuildApp
  displayName: 'Build, Testes e Publicação de Imagem'
  dependsOn: criarInfra
  jobs:
  - job: build
    displayName: 'Maven build + Docker push'
    steps:
    # JDK 17
    - task: JavaToolInstaller@0
      inputs:
        versionSpec: '17'
        jdkArchitectureOption: 'x64'
        jdkSourceOption: 'PreInstalled'

    # Build + testes Maven
    - script: |
        mvn -v
        mvn -B -ntp clean test package
      displayName: 'Build e testes Maven'

    # Publicar artefatos (JAR + imageTag)
    - script: |
        mkdir -p "$(Build.ArtifactStagingDirectory)"
        cp target/*.jar "$(Build.ArtifactStagingDirectory)" || true
        echo "$(imageName):$(Build.BuildId)" > "$(Build.ArtifactStagingDirectory)/imageTag.txt"
      displayName: 'Preparar artefatos'
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifact: 'drop'
        publishLocation: 'pipeline'
      displayName: 'Publicar artefatos no Azure DevOps'

    # Build & Push Docker para o ACR
    - task: AzureCLI@2
      displayName: 'Docker build e push para ACR'
      inputs:
        azureSubscription: 'MyAzureSubscription'
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          set -e
          acr='$(acrName)'
          img='$(imageName):$(Build.BuildId)'

          loginServer=$(az acr show -n "$acr" --query loginServer -o tsv)
          az acr login -n "$acr"

          docker build -t "$img" .
          docker tag "$img" "$loginServer/$img"
          docker push "$loginServer/$img"

          echo "##vso[task.setvariable variable=imageTag;isOutput=true]$img"
          echo "Imagem publicada: $loginServer/$img"

# ================== 3) CD ==================
- stage: deployApp
  displayName: 'Deploy no Azure Web App (Container)'
  dependsOn: BuildApp
  jobs:
  - job: deploy
    displayName: 'Atualizar container do WebApp'
    steps:
    - task: AzureCLI@2
      displayName: 'Apontar WebApp para imagem do ACR'
      inputs:
        azureSubscription: 'MyAzureSubscription'
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          set -e
          rg='$(resourceGroup)'
          app='$(appName)'
          acr='$(acrName)'
          imageTag='$(imageTag)'

          loginServer=$(az acr show -n "$acr" --query loginServer -o tsv)

          # Credenciais admin do ACR (porque criamos com --admin-enabled true)
          acrUser=$(az acr credential show -n "$acr" --query username -o tsv)
          acrPass=$(az acr credential show -n "$acr" --query "passwords[0].value" -o tsv)

          # Web Apps em Linux esperam 80 por padrão — sua app expõe 8080
          az webapp config appsettings set -g "$rg" -n "$app" --settings WEBSITES_PORT=8080 1>/dev/null

          az webapp config container set -g "$rg" -n "$app" \
            --docker-custom-image-name "$loginServer/$imageTag" \
            --docker-registry-server-url "https://$loginServer" \
            --docker-registry-server-user "$acrUser" \
            --docker-registry-server-password "$acrPass" 1>/dev/null

          echo "Deploy OK: $loginServer/$imageTag"
